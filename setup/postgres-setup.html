
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"/>
        <title>Postgres setup</title>
        <meta name="description" content="Connect Compas to Postgres"/>
        <link rel="canonical" href="https://compasjs.com/setup/postgres-setup.html"/>
        <style>
            body {margin: 5% auto; background: #f2f2f2; color: #444444; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 1.8; text-shadow: 0 1px 0 #ffffff; max-width: 73%;}
            pre, code {background: white;}
            pre {padding-left: 2px; line-height: 1.2; }
            code {margin-left: 2px; margin-right: 2px; }
            a {border-bottom: 1px solid #444444; color: #444444; text-decoration: none;}
            a:hover {border-bottom: 0;}
            a.anchor { float: right; text-decoration: none; padding: 1px 3px; border-bottom: none; }
            .hljs{display:block;overflow-x:auto;padding:.5em;background:#f0f0f0}.hljs,.hljs-subst{color:#444}.hljs-comment{color:#888}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#bc6060}.hljs-literal{color:#78a960}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta-string{color:#4d99bf}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}
        </style>
    </head>
    <body>
    <header>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/setup/index.html">Project setup</a></nav>
    </header>
    <main>
    <article>
        <h1 id="postgres-setup">
  Postgres setup
  
</h1>
<p>Most projects also require some way of persisting data. Compas aides in
providing a PostgreSQL client and some utilities around setting up a database.</p>
<h2 id="starting-postgresql">
  Starting PostgreSQL
  <a name="starting-postgresql" class="anchor" href="#starting-postgresql">#</a>
</h2>
<p>First that we need to make sure we have a running PostgreSQL instance. Compas
helps here, by managing a Docker based PostgreSQL server. Previously you have
already installed <code>@compas/cli</code>, which contains the necessary commands.</p>
<pre><code class="language-shell">yarn compas docker up
</code></pre>
<p>As you may have seen in the output, it does not only start a PostgreSQL
container, but also a Minio container. Minio is a S3 compatible document store,
which can be used for saving files.</p>
<p>Some other docker commands provided by <code>@compas/cli</code>:</p>
<pre><code class="language-shell"><span class="hljs-meta"># </span><span class="language-bash">Stop the running containers</span>
yarn compas docker down
<span class="hljs-meta"># </span><span class="language-bash">Remove all created Docker containers and volumes</span>
yarn compas docker clean
</code></pre>
<h2 id="setup-compasstore">
  Setup @compas/store
  <a name="setup-compasstore" class="anchor" href="#setup-compasstore">#</a>
</h2>
<p>The <code>@compas/store</code> packages provides a few abstractions over PostgreSQL and
Minio:</p>
<ul>
<li>Schema migration runner</li>
<li>Persistent file storage</li>
<li>Cache files on local disk</li>
<li>Job queue implementation, supporting priority, recurring jobs, scheduled jobs
and multiple workers</li>
<li>Session store compatible with the <code>session</code> middleware exported by
<code>@compas/server</code>.</li>
<li>Test databases for integration testing</li>
</ul>
<p>These features are mostly powered by a set of environment variables. Add the
following to you <code>.env</code> file:</p>
<pre><code class="language-dotenv">APP_NAME=compastodo
# Postgres
POSTGRES_HOST=localhost:5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
# Minio
MINIO_URI=localhost
MINIO_PORT=9000
MINIO_ACCESS_KEY=minio
MINIO_SECRET_KEY=minio123
</code></pre>
<p>Let&#39;s break it down a bit. <code>APP_NAME</code> is used in various places, but most
importantly it is the default name for your database, file bucket and logs. Then
we have some PostgreSQL connection configuration, kept as simple as possible,
and the same for Minio.</p>
<p>And lastly we need to install <code>@compas/store</code>:</p>
<pre><code class="language-shell">yarn add @compas/store --exact
</code></pre>
<h2 id="connecting">
  Connecting
  <a name="connecting" class="anchor" href="#connecting">#</a>
</h2>
<p>Now that we have everything setup, let&#39;s see if we can make a connection to
PostgreSQL. Create a file at <code>scripts/database.js</code> with the following contents:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> { mainFn } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/stdlib&quot;</span>;
<span class="hljs-keyword">import</span> { newPostgresConnection } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/store&quot;</span>;

<span class="hljs-comment">// Remember, mainFn reads our `.env` file automatically</span>
<span class="hljs-title function_">mainFn</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>, main);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">logger</span>) {
  <span class="hljs-keyword">const</span> sql = <span class="hljs-keyword">await</span> <span class="hljs-title function_">newPostgresConnection</span>({
    <span class="hljs-attr">createIfNotExists</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Create a new database if `compastodo` is not found</span>
  });

  logger.<span class="hljs-title function_">info</span>({
    <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> sql<span class="hljs-string">`SELECT 1 + 1 as &quot;sum&quot;`</span>,
  });

  <span class="hljs-comment">// Close the connection</span>
  <span class="hljs-keyword">await</span> sql.<span class="hljs-title function_">end</span>();
}
</code></pre>
<p>This ties in various parts of your local environment. We don&#39;t have any tables
yet in our database, so we execute a &#39; simple&#39; sum query and log the result. So
let&#39;s run it:</p>
<pre><code class="language-shell">yarn compas database
<span class="hljs-meta"># </span><span class="language-bash">or</span>
node ./scripts/database.js
</code></pre>
<h2 id="services-and-testing">
  Services and testing
  <a name="services-and-testing" class="anchor" href="#services-and-testing">#</a>
</h2>
<p>The database connection is most likely the best example where ES Module live
bindings shine. By setting the connection as such, we can quickly swap out the
database connection used in tests. Add the following to <code>src/services/core.js</code></p>
<pre><code class="language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> sql = <span class="hljs-literal">undefined</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setSql</span>(<span class="hljs-params">connection</span>) {
  <span class="hljs-keyword">if</span> (logger) {
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;setting services-&gt;sql&quot;</span>);
  }
  sql = connection;
}
</code></pre>
<p>Now create a file for some logic at <code>src/todo/events.js</code> with the following:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> { sql } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../services/core.js&quot;</span>;

<span class="hljs-comment">/**
 * Count all rows in &quot;myTable&quot;
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;number&gt;</span>}
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">todoCount</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [result] = <span class="hljs-keyword">await</span> sql<span class="hljs-string">`select COUNT(*) as sum from &quot;myTable&quot;`</span>;

  <span class="hljs-keyword">return</span> result.<span class="hljs-property">sum</span>;
}
</code></pre>
<p>Notice that we don&#39;t have <code>myTable</code> yet, but we can still write a test for it.
Create <code>src/todo/events.test.js</code> and add the following contents:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> { test, mainTestFn } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/cli&quot;</span>;
<span class="hljs-keyword">import</span> {
  createTestPostgresDatabase,
  cleanupTestPostgresDatabase,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/store&quot;</span>;
<span class="hljs-keyword">import</span> { sql, setSql } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../services/core.js&quot;</span>;
<span class="hljs-keyword">import</span> { todoCount } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./events.js&quot;</span>;

<span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;todo/events&quot;</span>, <span class="hljs-keyword">async</span> (t) =&gt; {
  t.<span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;setup&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// A sub test doesn&#x27;t need to do any assertions</span>
    <span class="hljs-title function_">setSql</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">createTestPostgresDatabase</span>());

    <span class="hljs-comment">// Create `myTable`</span>
    <span class="hljs-keyword">await</span> sql<span class="hljs-string">`CREATE TABLE &quot;myTable&quot; ( id SERIAL PRIMARY KEY );`</span>;
    <span class="hljs-comment">// Insert some values</span>
    <span class="hljs-keyword">await</span> sql<span class="hljs-string">`INSERT INTO &quot;myTable&quot; (&quot;id&quot;) VALUES (DEFAULT), (DEFAULT);`</span>;
  });

  t.<span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;todoCount - return the correct number&quot;</span>, <span class="hljs-keyword">async</span> (t) =&gt; {
    <span class="hljs-comment">// This uses our test connection, created above.</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">todoCount</span>();
    t.<span class="hljs-title function_">equal</span>(result, <span class="hljs-number">2</span>);
  });

  t.<span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;teardown&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// Cleans up the created database</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">cleanupTestPostgresDatabase</span>(sql);
    <span class="hljs-comment">// Make sure to reset the &#x27;sql&#x27; variable</span>
    <span class="hljs-title function_">setSql</span>(<span class="hljs-literal">undefined</span>);
  });
});
</code></pre>
<p>For these cases <code>@compas/store</code> exports the function
<code>createTestPostgresDatabase</code> and <code>cleanupTestPostgresDatabase</code>. This creates a
structural copy of your database, truncating all tables and returns the
connection.</p>

    </article>
    
    </main>
    <footer>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/setup/index.html">Project setup</a></nav>
    </footer>
    </body>
</html>
  