
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"/>
        <title>@compas/store</title>
        <meta name="description" content="Public API of @compas/store"/>
        <link rel="canonical" href="https://compasjs.com/api/store.html"/>
        <style>
            body {margin: 5% auto; background: #f2f2f2; color: #444444; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 1.8; text-shadow: 0 1px 0 #ffffff; max-width: 73%;}
            pre, code {background: white;}
            pre {padding-left: 2px; line-height: 1.2; }
            code {margin-left: 2px; margin-right: 2px; }
            a {border-bottom: 1px solid #444444; color: #444444; text-decoration: none;}
            a:hover {border-bottom: 0;}
            a.anchor { float: right; text-decoration: none; padding: 1px 3px; border-bottom: none; }
            .hljs{display:block;overflow-x:auto;padding:.5em;background:#f0f0f0}.hljs,.hljs-subst{color:#444}.hljs-comment{color:#888}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#bc6060}.hljs-literal{color:#78a960}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta-string{color:#4d99bf}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}
        </style>
    </head>
    <body>
    <header>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/api/index.html">API Documentation</a></nav>
    </header>
    <main>
    <article>
        <h1 id="compasstore">
  @compas/store
  
</h1>
<h2 id="newpostgresconnection">
  newPostgresConnection
  <a name="newpostgresconnection" class="anchor" href="#newpostgresconnection">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function newPostgresConnection(opts?, opts.createIfNotExists?):
Promise<Postgres></em><br><p>Create a new postgres connection, using the default environment variables. A
database may be created using the provided credentials.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>opts <code>object?</code></li>
<li>opts.createIfNotExists <code>boolean?</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/postgres.js#L52">source</a></em><br><h2 id="setstorequeries">
  setStoreQueries
  <a name="setstorequeries" class="anchor" href="#setstorequeries">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function setStoreQueries({typeof
import(&quot;./generated/database/index.js&quot;).queries} q): void</em><br><p>Overwrite used generated queries. This is needed when you want cascading soft
deletes to any of the exposed types. It is mandatory to be called if &#39;files&#39;,
&#39;session&#39; or &#39;jobs&#39; are used. If you don&#39;t use the generators, you can use
<code>storeQueries</code> as exported by <code>@compas/store</code>.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>{typeof import(&quot;./generated/database/index.js&quot;).queries} q
<code>{typeof import(&quot;./generated/database/index.js&quot;).queries} q</code>: {typeof
import(&quot;./generated/database/index.js&quot;).queries} q</li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/generated.js#L15">source</a></em><br><h2 id="query">
  query
  <a name="query" class="anchor" href="#query">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function query({string[]} strings, values): QueryPart<T></em><br><p>Format and append query parts, and execute the final result in a safe way.
Undefined values are skipped, as they are not allowed in queries. The query call
may be one of the interpolated values. Supports being called as a template
literal.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>{string[]} strings <code>{string[]} strings</code>: {string[]} strings</li>
<li>values <code>...*</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L15">source</a></em><br><h2 id="isquerypart">
  isQueryPart
  <a name="isquerypart" class="anchor" href="#isquerypart">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function isQueryPart(query): boolean</em><br><p>Check if the passed in value is an object generated by &#39;query``&#39;.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>query <code>*</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L90">source</a></em><br><h2 id="stringifyquerypart">
  stringifyQueryPart
  <a name="stringifyquerypart" class="anchor" href="#stringifyquerypart">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function stringifyQueryPart(queryPart, options): {string|{ sql: string,
params:[] }}</em><br><p>Stringify a queryPart. When interpolateParameters is true, we do a best effort
in replacing the parameterized query with the real params. If the result doesn&#39;t
look right, please turn it off.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>queryPart <code>QueryPart</code></li>
<li>options <code>{ interpolateParameters?: boolean }</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L109">source</a></em><br><h2 id="explainanalyzequery">
  explainAnalyzeQuery
  <a name="explainanalyzequery" class="anchor" href="#explainanalyzequery">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function explainAnalyzeQuery(sql, queryItem, jsonResult?):
Promise&lt;string|object&gt;</em><br><p>Creates a transaction, executes the query, and rollback the transaction
afterwards. This is safe to use with insert, update and delete queries. By
default returns text, but can also return json. Note that explain output is
highly depended on the current data and usage of the tables.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>queryItem <code>QueryPart</code></li>
<li>jsonResult <code>boolean?</code>: =false</li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L158">source</a></em><br><h2 id="newmigratecontext">
  newMigrateContext
  <a name="newmigratecontext" class="anchor" href="#newmigratecontext">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function newMigrateContext(sql, migrationDirectory): Promise<MigrateContext></em><br><p>Create a new migration context, resolves all migrations and collects the current
migration state.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>migrationDirectory <code>string</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/migrations.js#L27">source</a></em><br><h2 id="getmigrationstobeapplied">
  getMigrationsToBeApplied
  <a name="getmigrationstobeapplied" class="anchor" href="#getmigrationstobeapplied">#</a>
</h2>
<em>Available since 0.1.0</em><br><p>_function getMigrationsToBeApplied(mc): { migrationQueue: { name: string,
number: number, repeatable: boolean _</p>
<p>Get the migrations to be applied from the provided migration context. Note that
&#39;repeatable&#39; migrations are always in both the <code>migrationQueue</code> and
<code>hashChanges</code>.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>mc <code>MigrateContext</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/migrations.js#L96">source</a></em><br><h2 id="runmigrations">
  runMigrations
  <a name="runmigrations" class="anchor" href="#runmigrations">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function runMigrations(mc): Promise<undefined></em><br><p>Run the migrations currently pending in the migration context.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>mc <code>MigrateContext</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/migrations.js#L127">source</a></em><br><h2 id="addeventtoqueue">
  addEventToQueue
  <a name="addeventtoqueue" class="anchor" href="#addeventtoqueue">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function addEventToQueue(sql, eventName, data): Promise<number></em><br><p>Add an event to the job queue. Use this if the default priority is important,
like sending the user an email to verify their email. Runs with priority &#39;2&#39;,
the only higher priority values are priority &#39;0&#39; and &#39;1&#39;. Custom timeouts can&#39;t
be described via this mechanism.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>eventName <code>string</code></li>
<li>data <code>object</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L418">source</a></em><br><h2 id="addjobtoqueue">
  addJobToQueue
  <a name="addjobtoqueue" class="anchor" href="#addjobtoqueue">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function addJobToQueue(sql, job): Promise<number></em><br><p>Add a new job to the queue. Use this for normal jobs or to customize the job
priority. The default priority is &#39;5&#39;.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>job <code>JobInput</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L440">source</a></em><br><h2 id="addrecurringjobtoqueue">
  addRecurringJobToQueue
  <a name="addrecurringjobtoqueue" class="anchor" href="#addrecurringjobtoqueue">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function addRecurringJobToQueue(sql, job): Promise<void></em><br><p>Add a recurring job, if no existing job with the same name is scheduled. Does
not throw when a job is already pending with the same name. If exists will
update the interval. The default priority is &#39;4&#39;, which is a bit more important
than other jobs.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>job
<code>{ name: string, priority?: number|undefined, interval: StoreJobInterval }</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L510">source</a></em><br><h2 id="addjobwithcustomtimeouttoqueue">
  addJobWithCustomTimeoutToQueue
  <a name="addjobwithcustomtimeouttoqueue" class="anchor" href="#addjobwithcustomtimeouttoqueue">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function addJobWithCustomTimeoutToQueue(sql, job, timeout): Promise<number></em><br><p>Add a new job to the queue. Use this for normal jobs or to customize the job
priority. The default priority is &#39;5&#39;. The timeout value must be an integer
higher than 10. The timeout value represents the number of milliseconds the
handler may run, before the &#39;InsightEvent&#39; is aborted.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>job <code>JobInput</code></li>
<li>timeout <code>number</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L472">source</a></em><br><h2 id="getuncompletedjobsbyname">
  getUncompletedJobsByName
  <a name="getuncompletedjobsbyname" class="anchor" href="#getuncompletedjobsbyname">#</a>
</h2>
<em>Available since undefined</em><br><em>function getUncompletedJobsByName(sql): {Promise&lt;Object&lt;string,
QueryResultStoreJob[]&gt;&gt;}</em><br><p>Get all uncompleted jobs from the queue. Useful for testing if jobs are created.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L671">source</a></em><br><h2 id="newsessionstore">
  newSessionStore
  <a name="newsessionstore" class="anchor" href="#newsessionstore">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function newSessionStore(sql): SessionStore</em><br><p>Create a new session store, to be used in combination with the <code>session</code> as
provided in <code>@compas/server</code>.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/sessions.js#L44">source</a></em><br><h2 id="newminioclient">
  newMinioClient
  <a name="newminioclient" class="anchor" href="#newminioclient">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function newMinioClient(opts): minio.Client</em><br><p>Create a minio client with the default environment variables as defaults. Minio
is an S3 compatible client, so can be used against any S3 compatible interface.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>opts <code>object</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L13">source</a></em><br><h2 id="ensurebucket">
  ensureBucket
  <a name="ensurebucket" class="anchor" href="#ensurebucket">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function ensureBucket(minio, bucketName, region): Promise<undefined></em><br><p>Make sure a bucket exists and if it doesn&#39;t create it.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
<li>region <code>string</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L34">source</a></em><br><h2 id="removebucket">
  removeBucket
  <a name="removebucket" class="anchor" href="#removebucket">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function removeBucket(minio, bucketName): Promise<undefined></em><br><p>Remove the provided bucket name. Note that this will fail if a bucket has
objects.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L74">source</a></em><br><h2 id="listobjects">
  listObjects
  <a name="listobjects" class="anchor" href="#listobjects">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function listObjects(minio, bucketName, filter?): Promise&lt;{name: string,
prefix: string, size: number, etag: string, lastModified: Date</em><br><p>List all objects in a bucket.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
<li>filter <code>string?</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L52">source</a></em><br><h2 id="removebucketandobjectsinbucket">
  removeBucketAndObjectsInBucket
  <a name="removebucketandobjectsinbucket" class="anchor" href="#removebucketandobjectsinbucket">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function removeBucketAndObjectsInBucket(minio, bucketName): Promise<undefined></em><br><p>Force removal of a bucket by listing and removing it&#39;s objects.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L87">source</a></em><br><h2 id="createorupdatefile">
  createOrUpdateFile
  <a name="createorupdatefile" class="anchor" href="#createorupdatefile">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function createOrUpdateFile(sql, minio, bucketName, props, streamOrPath):
Promise<StoreFile></em><br><p>Create or update a file. The file store is backed by a Postgres table and S3
object.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
<li>props <code>StoreFileInsertPartial</code></li>
<li>streamOrPath <code>ReadStream|string</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L37">source</a></em><br><h2 id="copyfile">
  copyFile
  <a name="copyfile" class="anchor" href="#copyfile">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function copyFile(sql, minio, bucketName, id, targetBucket?):
Promise<StoreFile></em><br><p>Create both a Postgres record copy and an S3 object copy of the provided file
id, into the provided bucket.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
<li>id <code>string</code></li>
<li>targetBucket <code>string=bucketName</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L118">source</a></em><br><h2 id="getfilestream">
  getFileStream
  <a name="getfilestream" class="anchor" href="#getfilestream">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function getFileStream(minio, bucketName, id, seek?):
Promise&lt;NodeJS.ReadableStream&gt;</em><br><p>Get a file stream based on the &#39;id&#39;. It is expected that an object exists with
the &#39;id&#39;. A &#39;start&#39; and &#39;end&#39; value can optionally be specified.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
<li>id <code>string</code></li>
<li>seek <code>{ start?: number|undefined, end?: number|undefined }={}</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L90">source</a></em><br><h2 id="syncdeletedfiles">
  syncDeletedFiles
  <a name="syncdeletedfiles" class="anchor" href="#syncdeletedfiles">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function syncDeletedFiles(sql, minio, bucketName): Promise<undefined></em><br><p>File deletes should be done via <code>queries.storeFileDeletePermanent()</code>. By calling
this function, all files that don&#39;t exist in the database will be removed from
the S3 bucket.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>minio <code>minio.Client</code></li>
<li>bucketName <code>string</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L156">source</a></em><br><h2 id="updatefilegrouporder">
  updateFileGroupOrder
  <a name="updatefilegrouporder" class="anchor" href="#updatefilegrouporder">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function updateFileGroupOrder(sql, {string[]} ids): Promise<undefined></em><br><p>Update the order of the provided id&#39;s in relation to each other. This function
does not check if all files are in the same group, please use
getFileGroupParents for that.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
<li>{string[]} ids <code>{string[]} ids</code>: {string[]} ids</li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/file-group.js#L62">source</a></em><br><h2 id="createtestpostgresdatabase">
  createTestPostgresDatabase
  <a name="createtestpostgresdatabase" class="anchor" href="#createtestpostgresdatabase">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function createTestPostgresDatabase(verboseSql?, connectionOptions?):
Promise<Postgres></em><br><p>Create a new test database, using the default database as it&#39;s template. The
copied database will be fully truncated, except for the &#39;migrations&#39; table. To
do this, all connections to the default database are forcefully killed. Returns
a connection to the new database.</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>verboseSql <code>boolean=false</code>: If true, creates a new logger and prints all
queries.</li>
<li>connectionOptions <code>object?</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/testing.js#L74">source</a></em><br><h2 id="cleanuptestpostgresdatabase">
  cleanupTestPostgresDatabase
  <a name="cleanuptestpostgresdatabase" class="anchor" href="#cleanuptestpostgresdatabase">#</a>
</h2>
<em>Available since 0.1.0</em><br><em>function cleanupTestPostgresDatabase(sql): Promise<undefined></em><br><p>Remove a created test database</p>
<p><strong>Parameters</strong>:</p>
<ul>
<li>sql <code>Postgres</code></li>
</ul>
<em><a href="https://github.com/compasjs/compas/blob/main/packages/store/src/testing.js#L163">source</a></em><br>
    </article>
    
    </main>
    <footer>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/api/index.html">API Documentation</a></nav>
    </footer>
    </body>
</html>
  