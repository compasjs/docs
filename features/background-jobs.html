
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"/>
        <title>Background jobs</title>
        <meta name="description" content="Compas background jobs"/>
        <link rel="canonical" href="https://compasjs.com/features/background-jobs.html"/>
        <style>
            body {margin: 5% auto; background: #f2f2f2; color: #444444; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 1.8; text-shadow: 0 1px 0 #ffffff; max-width: 73%;}
            pre, code {background: white;}
            pre {padding-left: 2px; line-height: 1.2; }
            code {margin-left: 2px; margin-right: 2px; }
            a {border-bottom: 1px solid #444444; color: #444444; text-decoration: none;}
            a:hover {border-bottom: 0;}
            a.anchor { float: right; text-decoration: none; padding: 1px 3px; border-bottom: none; }
            .hljs{display:block;overflow-x:auto;padding:.5em;background:#f0f0f0}.hljs,.hljs-subst{color:#444}.hljs-comment{color:#888}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#bc6060}.hljs-literal{color:#78a960}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta-string{color:#4d99bf}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}
        </style>
    </head>
    <body>
    <header>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/features/index.html">Features</a></nav>
    </header>
    <main>
    <article>
        <h1 id="background-jobs">
  Background jobs
  
</h1>
<p>The queue system is based on &#39;static&#39; units of work to be done in the
background. It supports the following:</p>
<ul>
<li>Job priority&#39;s. Lower value means higher priority.</li>
<li>Scheduling jobs at a set time</li>
<li>Customizable handler timeouts</li>
<li>Recurring job handling</li>
<li>Concurrent workers pulling from the same queue</li>
<li>Specific workers for a specific job</li>
</ul>
<p>When to use which function of adding a job:</p>
<ul>
<li><code>addEventToQueue</code>: use the queue as an &#39;external&#39; message bus to do things
based on user flows, like sending an verification email on when registering.
Jobs created will have a priority of &#39;2&#39;.</li>
<li><code>addJobToQueue</code>: use the queue as background processing of defined units. Like
converting a file to different formats, sending async or scheduled
notifications. Jobs created will have a priority of &#39;5&#39;.</li>
<li><code>addRecurringJobToQueue</code>: use the queue for recurring background processing,
like cleaning up sessions, generating daily reports. The interval can be as
low as a second. Jobs created will have a priority of &#39;4&#39;. This means the
recurring jobs are by default more important than normal jobs. However there
are no guarantees that jobs are running exactly on the time they are
scheduled.</li>
<li><code>addJobWithCustomTimeoutToQueue</code>: when the unit of work is hard to define
statically for the job. For example an external api that needs all information
in a single call, but the amount of information is of value N. And N doesn&#39;t
have any bounds and is only known when the job is created. However, this sort
of still enforces that the unit of work is related to some other property to
consistently calculate a custom timeout. These jobs have a priority of &#39;5&#39; by
default.</li>
</ul>
<p>The handler can be passed in, in 2 ways;</p>
<ul>
<li>A single handler dispatching over the different jobs in application code</li>
<li>A plain JS object containing job names as strings, and handler with optional
timeout as value.</li>
</ul>
<p>The timeout of a created job overwrites the specific job timeout which
overwrites the &#39;handlerTimeout&#39; option.</p>
<p>Note that a lower priority value means a higher priority.</p>
<h2 id="api">
  API
  <a name="api" class="anchor" href="#api">#</a>
</h2>
<p>Provided by <code>@compas/store</code>.</p>
<p>See also:</p>
<ul>
<li><a href="https://compasjs.com/api/store.html#addeventtoqueue"><code>addEventToQueue</code></a></li>
<li><a href="https://compasjs.com/api/store.html#addjobtoqueue"><code>addJobToQueue</code></a></li>
<li><a href="https://compasjs.com/api/store.html#addrecurringjobtoqueue"><code>addRecurringJobToQueue</code></a></li>
<li><a href="https://compasjs.com/api/store.html#addjobwithcustomtimeouttoqueue"><code>addJobWithCustomTimeoutToQueue</code></a></li>
</ul>
<h3 id="jobqueueworker">
  JobQueueWorker
  <a name="jobqueueworker" class="anchor" href="#jobqueueworker">#</a>
</h3>
<p>A class representing a worker. By default a JobQueueWorker handles all jobs,
however it is possible to have a specific worker for jobs with specific names.</p>
<p><strong>constructor()</strong>:</p>
<p>Create a new JobQueueWorker instance.</p>
<p>Parameters:</p>
<ul>
<li><p><code>sql</code>: A Postgres connection. The connection should not be in a transaction
already.</p>
</li>
<li><p><code>name</code> (string): Optional name that this JobQueueWorker will filter the jobs
on. If not necessary, argument can be skipped.</p>
</li>
<li><p><code>options</code>:</p>
<ul>
<li><p><code>pollInterval</code> (number): Interval in milliseconds that the worker should
look for new jobs. Is only used if no job is found directly after completing
a job. Defaults to 1500 milliseconds</p>
</li>
<li><p><code>parallelCount</code> (number): The number of parallel jobs to take on. This
number should not be higher than the amount of connections your sql instance
may create. Defaults to 1.</p>
</li>
<li><p><code>handlerTimeout</code> (number): The number of milliseconds the handler may run
before it should be aborted. Note that only <code>newEventFromEvent</code> and
<code>eventStart</code> check if an event is aborted by default. Defaults to 30
seconds.</p>
</li>
<li><p><code>handler</code> (function|object): The callback that is called on new jobs. If a
job throws, the job is not marked as complete and retried most likely
immediately. If an object is passed in it acts as a lookup table based on
the job name. If no handler is found, the job will automatically pass. The
object values may be just an handler or the following object:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> specifcHandlerSpecification = {
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> (event, sql, job) =&gt; {},
  <span class="hljs-attr">timout</span>: <span class="hljs-number">1400</span>, <span class="hljs-comment">// 1.4 seconds</span>
};
</code></pre>
<p>The handler is called with the following parameters:</p>
<ul>
<li><code>event</code>: An @compas/stdlib event, which is aborted after the specified
timeout. The event is already started and will be stopped by the job
worker.</li>
<li><code>sql</code>: A Postgres connection already in transaction. If the transaction is
aborted, the job is not marked complete.</li>
<li><code>job</code>: The job, containing <code>name</code>, <code>data</code>, <code>priority</code>, <code>scheduledAt</code>,
<code>handlerTimeout</code>, <code>retryCount</code> and <code>createdAt</code> properties.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Returns a new <code>JobQueueWorker</code> instance that is not started yet.</p>
<p><strong>start()</strong>:</p>
<p>Starts the worker if not already started. Returns synchronously.</p>
<p><strong>stop</strong>:</p>
<p>Stops the worker if not already stopped. Already running jobs will finish, but
no new jobs will be picked up. Returns synchronously.</p>
<p><strong>pendingQueueSize()</strong>:</p>
<p>Get the amount of pending jobs left. If <code>name</code> is passed in the constructor,
only pending jobs with the specified name will be returned.</p>
<p>Returns a promise that fulfills with an object.</p>
<ul>
<li><code>pendingCount</code>: The amount of jobs to be done in the future</li>
<li><code>scheduledCount</code>: The amount of jobs that is waiting on an available worker
now.</li>
</ul>
<p><strong>averageTimeToCompletion()</strong>:</p>
<p>Get the average time to job completion between the specified start and end
dates. If <code>name</code> is passed in the constructor, only jobs with the specified name
will calculated.</p>
<p>Parameters:</p>
<ul>
<li><code>startDate</code> (Date): Date to filter jobs that completed after the specified
timestamp.</li>
<li><code>endDate</code> (Date): Date to filter jobs that completed before the specified
timestamp.</li>
</ul>
<p>Returns a promise that fulfills with a number.</p>
<p><strong>Example</strong></p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JobQueueWorker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/store&quot;</span>;

<span class="hljs-title function_">mainFn</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>, main);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">logger</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params">sql, { name, data }</span>) =&gt; {
    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">&quot;myImportantJob&quot;</span>) {
      logger.<span class="hljs-title function_">info</span>(data);
    } <span class="hljs-keyword">else</span> {
      logger.<span class="hljs-title function_">error</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Unhandled job&quot;</span>,
        name,
      });
    }
  };

  <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobQueueWorker</span>(sql, {
    handler,
    <span class="hljs-attr">parallelCount</span>: <span class="hljs-number">2</span>,
  });

  worker.<span class="hljs-title function_">start</span>();
  <span class="hljs-keyword">const</span> startDate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
  <span class="hljs-keyword">const</span> endDate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();

  <span class="hljs-comment">// Set startDate 3 days in the past</span>
  startDate.<span class="hljs-title function_">setUTCDate</span>(startDate.<span class="hljs-title function_">getUTCDate</span>() - <span class="hljs-number">3</span>);

  logger.<span class="hljs-title function_">info</span>({
    <span class="hljs-attr">pendingQueueSize</span>: <span class="hljs-keyword">await</span> worker.<span class="hljs-title function_">pendingQueueSize</span>(),
    <span class="hljs-attr">averageTimeToCompletion</span>: <span class="hljs-keyword">await</span> worker.<span class="hljs-title function_">averageTimeToCompletion</span>(
      startDate,
      endDate,
    ),
  });
  worker.<span class="hljs-title function_">stop</span>();
}
</code></pre>

    </article>
    
    </main>
    <footer>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/features/index.html">Features</a></nav>
    </footer>
    </body>
</html>
  