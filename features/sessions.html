
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"/>
        <title>Sessions</title>
        <meta name="description" content="Compas sessions with store and server"/>
        <link rel="canonical" href="https://compasjs.com/features/sessions.html"/>
        <style>
            body {margin: 5% auto; background: #f2f2f2; color: #444444; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 1.8; text-shadow: 0 1px 0 #ffffff; max-width: 73%;}
            pre, code {background: white;}
            pre {padding-left: 2px; line-height: 1.2; }
            code {margin-left: 2px; margin-right: 2px; }
            a {border-bottom: 1px solid #444444; color: #444444; text-decoration: none;}
            a:hover {border-bottom: 0;}
            a.anchor { float: right; text-decoration: none; padding: 1px 3px; border-bottom: none; }
            .hljs{display:block;overflow-x:auto;padding:.5em;background:#f0f0f0}.hljs,.hljs-subst{color:#444}.hljs-comment{color:#888}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-meta-keyword,.hljs-name,.hljs-selector-tag{font-weight:700}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#800}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#bc6060}.hljs-literal{color:#78a960}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#397300}.hljs-meta{color:#1f7199}.hljs-meta-string{color:#4d99bf}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}
        </style>
    </head>
    <body>
    <header>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/features/index.html">Features</a></nav>
    </header>
    <main>
    <article>
        <h1 id="session-handling">
  Session handling
  
</h1>
<p>Compas comes with cookie based session handling based on @compas/server &amp;
@compas/store. Note that you need to use @compas/store based migrations to use
the Postgres backed store.</p>
<h2 id="session-setup">
  Session setup
  <a name="session-setup" class="anchor" href="#session-setup">#</a>
</h2>
<p>After enabling the migrations, enabling persistent sessions is just a few
function calls away. Start by creating a session store:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> { newSessionStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/store&quot;</span>;

<span class="hljs-comment">// Pass in a sql connection</span>
<span class="hljs-keyword">const</span> sessionsStore = newSessionStore(sql);
</code></pre>
<p>The session handler has a number of defaults which we handle later in this
document, for now let&#39;s create a Koa middleware to handle the sessions:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> { session, getApp } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@compas/server&quot;</span>;

<span class="hljs-keyword">const</span> app = getApp();
<span class="hljs-keyword">const</span> sessionMiddlewre = session(app, {
  <span class="hljs-attr">store</span>: sessionStore,
});
</code></pre>
<p>And now where ever we need sessions we can add the <code>sessionMiddleware</code> in to our
chain.</p>
<pre><code class="language-js">counterHandlers.init = [
  sessionMiddleware,
  <span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    ctx.session = {
      <span class="hljs-attr">counter</span>: <span class="hljs-number">0</span>,
    };

    ctx.body = {
      <span class="hljs-attr">value</span>: ctx.session.counter,
    };

    <span class="hljs-keyword">return</span> next();
  },
];

counterHandlers.increment = [
  sessionMiddleware,
  <span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-comment">// Check if a session is new</span>
    <span class="hljs-keyword">if</span> (ctx.session.isNew) {
      <span class="hljs-keyword">throw</span> AppError.validationError(<span class="hljs-string">&quot;error.sessionNotInitialized&quot;</span>, {
        <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Please call counterHandlers.init first&quot;</span>,
      });
    }

    <span class="hljs-comment">// Session is our object, so increment the value</span>
    ctx.session.counter++;

    ctx.body = {
      <span class="hljs-attr">value</span>: ctx.session.counter,
    };

    <span class="hljs-keyword">return</span> next();
  },
];

counterHandlers.destroy = [
  sessionMiddleware,
  <span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-comment">// Destroy the session</span>
    ctx.session = <span class="hljs-literal">null</span>;

    ctx.body = { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };

    <span class="hljs-keyword">return</span> next();
  },
];
</code></pre>
<p>The above code implements a counter per user. The session is persisted in to the
database and if the user comes back 5 days later, they still have the same
counter.</p>
<p>Under the hood the session middleware set&#39;s some cookies. To do this a few
things are needed:</p>
<ul>
<li>CORS handling, automatically done by <a href="/api/server.html#getapp"><code>getApp</code></a> if
not disabled.</li>
<li>The default options in <code>session</code>, overridable by the object passed as the
second argument<ul>
<li>The cookie <code>key</code> is based on the <code>APP_NAME</code> environment variable.</li>
<li>The <code>maxAge</code> value for the cookie in milliseconds. Defaults to 6 days.</li>
<li>Automatically <code>renew</code> the cookie if the cookie expires. Defaults to <code>true</code>.</li>
<li>Use a <code>secure</code> cookie when running in production, based on
<a href="/api/stdlib.html#isproduction"><code>isProduction</code></a></li>
<li>Set the <code>domain</code> based on the <code>COOKIE_URL</code> environment variable.</li>
<li>Set a <code>sameSite</code> value to &#39;lax&#39; so we can host the api on <code>api.compasjs.com</code>
and the frontend on <code>compasjs.com</code>.</li>
<li>Enable <code>overwrite</code> to just force a cookie on every request, this way the
<code>maxAge</code> resets on every request. Defaults to <code>true</code>.</li>
<li>Making the &#39;real&#39; session cookie <code>httpOnly</code>, defaults to true. So the
JavaScript in the browser can&#39;t tempter with it. Defaults to <code>true</code>.</li>
<li>Making sure the cookie is <code>signed</code>, by using the <code>APP_KEYS</code> environment
variables.</li>
<li>By enabling <code>autoCommit</code> to automatically persist the <code>ctx.session</code> object
to the database. Should probably be disabled for high traffic api&#39;s.</li>
</ul>
</li>
</ul>
<h2 id="keeppubliccookie">
  <code>keepPublicCookie</code>
  <a name="keeppubliccookie" class="anchor" href="#keeppubliccookie">#</a>
</h2>
<p>Another option not mentioned above is the <code>keepPublicCookie</code> option, defaulting
to <code>false</code>. This can only be enabled when a <code>store</code> is present like the
<a href="/api/store.html#newsessionstore">session store</a>. This option keeps another
cookie in sync with the session cookies that is readable by the JavaScript
running in the browser. It does not contain any information and to be really
sure that a valid session exists you still need to ask your api.</p>

    </article>
    
    </main>
    <footer>
        <nav><a href="https://compasjs.com/index.html">Compas</a> > <a href="https://compasjs.com/features/index.html">Features</a></nav>
    </footer>
    </body>
</html>
  